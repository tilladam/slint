// Simple Node Editor Example

// A bezier link between two pins
component Link inherits Path {
    in property <length> start-x;
    in property <length> start-y;
    in property <length> end-x;
    in property <length> end-y;
    in property <color> link-color: #888888;
    in property <length> line-width: 2px;

    // Calculate control point offset (horizontal bezier)
    property <length> dx: abs(end-x - start-x);
    property <length> offset: max(dx * 0.5, 50px);

    // Control points
    property <length> ctrl1-x: start-x + offset;
    property <length> ctrl1-y: start-y;
    property <length> ctrl2-x: end-x - offset;
    property <length> ctrl2-y: end-y;

    width: 100%;
    height: 100%;
    stroke: link-color;
    stroke-width: line-width;
    fill: transparent;

    // Set viewbox to match actual size so SVG coordinates map 1:1
    viewbox-x: 0;
    viewbox-y: 0;
    viewbox-width: self.width / 1px;
    viewbox-height: self.height / 1px;

    // SVG path command: M (move to), C (cubic bezier)
    commands: "M " + start-x / 1px + " " + start-y / 1px +
              " C " + ctrl1-x / 1px + " " + ctrl1-y / 1px +
              " " + ctrl2-x / 1px + " " + ctrl2-y / 1px +
              " " + end-x / 1px + " " + end-y / 1px;
}

// A basic node component
component Node inherits Rectangle {
    in property <string> title: "Node";
    in property <int> node-id;
    in-out property <length> node-x;
    in-out property <length> node-y;

    // Expose pin positions (center of pin circles, in parent coordinates)
    out property <length> input-pin-x: node-x + input-pin.x + 6px;
    out property <length> input-pin-y: node-y + input-pin.y + 6px;
    out property <length> output-pin-x: node-x + output-pin.x + 6px;
    out property <length> output-pin-y: node-y + output-pin.y + 6px;

    x: node-x;
    y: node-y;
    width: 150px;
    height: 80px;
    background: #2d2d2d;
    border-radius: 8px;
    border-width: 1px;
    border-color: #555;

    // Title bar
    Rectangle {
        x: 8px;
        y: 8px;
        width: parent.width - 16px;
        height: 24px;
        background: #3d3d3d;
        border-radius: 4px;

        Text {
            text: title;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    // Input pin (green) - positioned explicitly
    input-pin := Rectangle {
        x: 8px;
        y: 8px + 24px + 8px;  // below title bar
        width: 12px;
        height: 12px;
        background: #4CAF50;
        border-radius: 6px;
    }

    // Output pin (blue) - positioned explicitly
    output-pin := Rectangle {
        x: parent.width - 8px - 12px;
        y: 8px + 24px + 8px;  // below title bar
        width: 12px;
        height: 12px;
        background: #2196F3;
        border-radius: 6px;
    }

    // Drag handling
    TouchArea {
        moved => {
            if self.pressed {
                node-x += self.mouse-x - self.pressed-x;
                node-y += self.mouse-y - self.pressed-y;
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "Node Editor Example";
    width: 1200px;
    height: 800px;
    background: #1a1a1a;

    // Shared pan state
    property <length> pan-x: 0px;
    property <length> pan-y: 0px;
    property <float> zoom: 1.0;

    // The three-layer node editor structure
    NodeEditorBackground {
        width: 100%;
        height: 100%;
        pan-x <=> pan-x;
        pan-y <=> pan-y;
        zoom: zoom;
        grid-spacing: 24px;
        grid-color: #333333;
        background-color: #1a1a1a;
    }

    // Nodes layer (in the middle)
    input-node := Node {
        title: "Input";
        node-id: 1;
        node-x: 100px + pan-x;
        node-y: 200px + pan-y;
    }

    process-node := Node {
        title: "Process";
        node-id: 2;
        node-x: 350px + pan-x;
        node-y: 150px + pan-y;
    }

    output-node := Node {
        title: "Output";
        node-id: 3;
        node-x: 600px + pan-x;
        node-y: 200px + pan-y;
    }

    // Links layer (between nodes and overlay)
    // Link from Input's output to Process's input
    Link {
        start-x: input-node.output-pin-x;
        start-y: input-node.output-pin-y;
        end-x: process-node.input-pin-x;
        end-y: process-node.input-pin-y;
        link-color: #ff9800;
        line-width: 3px;
    }

    // Link from Process's output to Output's input
    Link {
        start-x: process-node.output-pin-x;
        start-y: process-node.output-pin-y;
        end-x: output-node.input-pin-x;
        end-y: output-node.input-pin-y;
        link-color: #2196f3;
        line-width: 3px;
    }

    // Overlay layer (on top)
    NodeEditorOverlay {
        width: 100%;
        height: 100%;
        pan-x <=> pan-x;
        pan-y <=> pan-y;
        zoom <=> zoom;
        min-zoom: 0.25;
        max-zoom: 4.0;
        selection-box-color: #4488ff40;
        active-link-color: #ffffff;

        link-created => {
            debug("Link created");
        }

        link-dropped => {
            debug("Link dropped");
        }

        context-menu-requested => {
            debug("Context menu requested");
        }
    }

    // Instructions overlay
    Rectangle {
        x: 10px;
        y: 10px;
        width: 280px;
        height: 120px;
        background: #00000080;
        border-radius: 8px;

        VerticalLayout {
            padding: 12px;
            spacing: 4px;

            Text { text: "Node Editor Controls:"; color: #fff; font-size: 14px; font-weight: 600; }
            Text { text: "Middle mouse: Pan"; color: #ccc; font-size: 12px; }
            Text { text: "Scroll wheel: Zoom"; color: #ccc; font-size: 12px; }
            Text { text: "Drag nodes to move them"; color: #ccc; font-size: 12px; }
            Text { text: "Shift+drag: Box select"; color: #ccc; font-size: 12px; }
        }
    }

    // Zoom indicator
    Rectangle {
        x: parent.width - 110px;
        y: 10px;
        width: 100px;
        height: 30px;
        background: #00000080;
        border-radius: 4px;

        Text {
            text: "Zoom: " + round(zoom * 100) + "%";
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}
