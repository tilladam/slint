// Simple Node Editor Example

// A bezier link between two pins
component Link inherits Path {
    in property <length> start-x;
    in property <length> start-y;
    in property <length> end-x;
    in property <length> end-y;
    in property <color> link-color: #888888;
    in property <length> line-width: 2px;

    // Calculate control point offset (horizontal bezier)
    property <length> dx: abs(end-x - start-x);
    property <length> offset: max(dx * 0.5, 50px);

    // Control points
    property <length> ctrl1-x: start-x + offset;
    property <length> ctrl1-y: start-y;
    property <length> ctrl2-x: end-x - offset;
    property <length> ctrl2-y: end-y;

    width: 100%;
    height: 100%;
    stroke: link-color;
    stroke-width: line-width;
    fill: transparent;

    // Set viewbox to match actual size so SVG coordinates map 1:1
    // Use max() to avoid zero-size viewbox during initial layout
    viewbox-x: 0;
    viewbox-y: 0;
    viewbox-width: max(self.width / 1px, 1);
    viewbox-height: max(self.height / 1px, 1);

    // SVG path command: M (move to), C (cubic bezier)
    commands: "M " + start-x / 1px + " " + start-y / 1px +
              " C " + ctrl1-x / 1px + " " + ctrl1-y / 1px +
              " " + ctrl2-x / 1px + " " + ctrl2-y / 1px +
              " " + end-x / 1px + " " + end-y / 1px;
}

// A basic node component with interactive pins
component Node inherits Rectangle {
    in property <string> title: "Node";
    in property <int> node-id;
    in property <int> input-pin-id: node-id * 10 + 1;   // e.g., node 1 -> pin 11
    in property <int> output-pin-id: node-id * 10 + 2;  // e.g., node 1 -> pin 12
    in-out property <length> node-x;
    in-out property <length> node-y;

    // Callback when pin drag starts (pin-id, x, y)
    callback pin-drag-started(int, length, length);

    // Pin dimensions
    property <length> pin-size: 12px;
    property <length> pin-radius: pin-size / 2;

    // Expose pin positions (center of pin circles, in parent coordinates)
    out property <length> input-pin-x: node-x + input-pin.x + pin-radius;
    out property <length> input-pin-y: node-y + input-pin.y + pin-radius;
    out property <length> output-pin-x: node-x + output-pin.x + pin-radius;
    out property <length> output-pin-y: node-y + output-pin.y + pin-radius;

    x: node-x;
    y: node-y;
    width: 150px;
    height: 80px;
    background: #2d2d2d;
    border-radius: 8px;
    border-width: 1px;
    border-color: #555;

    // Title bar
    Rectangle {
        x: 8px;
        y: 8px;
        width: parent.width - 16px;
        height: 24px;
        background: #3d3d3d;
        border-radius: 4px;

        Text {
            text: title;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    // Input pin (green) - with drag-to-link support
    input-pin := Rectangle {
        x: 8px;
        y: 8px + 24px + 8px;  // below title bar
        width: pin-size;
        height: pin-size;
        background: input-pin-touch.has-hover ? #66BB6A : #4CAF50;
        border-radius: pin-radius;

        input-pin-touch := TouchArea {
            pointer-event(event) => {
                if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                    pin-drag-started(input-pin-id, input-pin-x, input-pin-y);
                }
            }
        }
    }

    // Output pin (blue) - with drag-to-link support
    output-pin := Rectangle {
        x: parent.width - 8px - pin-size;
        y: 8px + 24px + 8px;  // below title bar
        width: pin-size;
        height: pin-size;
        background: output-pin-touch.has-hover ? #42A5F5 : #2196F3;
        border-radius: pin-radius;

        output-pin-touch := TouchArea {
            pointer-event(event) => {
                if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                    pin-drag-started(output-pin-id, output-pin-x, output-pin-y);
                }
            }
        }
    }

    // Drag handling for the node body
    TouchArea {
        moved => {
            if self.pressed {
                node-x += self.mouse-x - self.pressed-x;
                node-y += self.mouse-y - self.pressed-y;
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "Node Editor Example";
    width: 1200px;
    height: 800px;
    background: #1a1a1a;

    // Shared pan state
    property <length> pan-x: 0px;
    property <length> pan-y: 0px;
    property <float> zoom: 1.0;

    // The three-layer node editor structure
    NodeEditorBackground {
        width: 100%;
        height: 100%;
        pan-x <=> pan-x;
        pan-y <=> pan-y;
        zoom: zoom;
        grid-spacing: 24px;
        grid-color: #333333;
        background-color: #1a1a1a;
    }

    // Helper function to start link creation
    function start-link-creation(pin-id: int, x: length, y: length) {
        overlay.pending-link-pin-id = pin-id;
        overlay.pending-link-x = x;
        overlay.pending-link-y = y;
    }

    // Nodes layer (in the middle)
    input-node := Node {
        title: "Input";
        node-id: 1;
        node-x: 100px + pan-x;
        node-y: 200px + pan-y;
        pin-drag-started(pin-id, x, y) => { start-link-creation(pin-id, x, y); }
    }

    process-node := Node {
        title: "Process";
        node-id: 2;
        node-x: 350px + pan-x;
        node-y: 150px + pan-y;
        pin-drag-started(pin-id, x, y) => { start-link-creation(pin-id, x, y); }
    }

    output-node := Node {
        title: "Output";
        node-id: 3;
        node-x: 600px + pan-x;
        node-y: 200px + pan-y;
        pin-drag-started(pin-id, x, y) => { start-link-creation(pin-id, x, y); }
    }

    // Links layer (between nodes and overlay)
    // Link from Input's output to Process's input
    Link {
        start-x: input-node.output-pin-x;
        start-y: input-node.output-pin-y;
        end-x: process-node.input-pin-x;
        end-y: process-node.input-pin-y;
        link-color: #ff9800;
        line-width: 3px;
    }

    // Link from Process's output to Output's input
    Link {
        start-x: process-node.output-pin-x;
        start-y: process-node.output-pin-y;
        end-x: output-node.input-pin-x;
        end-y: output-node.input-pin-y;
        link-color: #2196f3;
        line-width: 3px;
    }

    // Overlay layer (on top)
    overlay := NodeEditorOverlay {
        width: 100%;
        height: 100%;
        pan-x <=> pan-x;
        pan-y <=> pan-y;
        zoom <=> zoom;
        min-zoom: 0.25;
        max-zoom: 4.0;
        selection-box-color: #4488ff40;
        active-link-color: #ffffff;

        link-created => {
            debug("Link created");
        }

        link-dropped => {
            debug("Link dropped");
        }

        context-menu-requested => {
            debug("Context menu at: " + overlay.context-menu-x / 1px + ", " + overlay.context-menu-y / 1px);
        }

        selection-changed => {
            debug("Selection changed");
        }
    }

    // Selection box (rendered based on overlay state)
    Rectangle {
        visible: overlay.is-selecting;
        x: overlay.selection-x;
        y: overlay.selection-y;
        width: overlay.selection-width;
        height: overlay.selection-height;
        background: #4488ff20;
        border-color: #4488ff;
        border-width: 1px;
    }

    // Active link preview (rendered during link creation)
    Link {
        visible: overlay.is-creating-link;
        start-x: overlay.link-start-x;
        start-y: overlay.link-start-y;
        end-x: overlay.link-end-x;
        end-y: overlay.link-end-y;
        link-color: #ffffff80;
        line-width: 2px;
    }

    // Instructions overlay
    Rectangle {
        x: 10px;
        y: 10px;
        width: 280px;
        height: 135px;
        background: #00000080;
        border-radius: 8px;

        VerticalLayout {
            padding: 12px;
            spacing: 4px;

            Text { text: "Node Editor Controls:"; color: #fff; font-size: 14px; font-weight: 600; }
            Text { text: "Middle mouse: Pan"; color: #ccc; font-size: 12px; }
            Text { text: "Scroll wheel: Zoom"; color: #ccc; font-size: 12px; }
            Text { text: "Drag nodes to move them"; color: #ccc; font-size: 12px; }
            Text { text: "Drag from pin: Create link"; color: #ccc; font-size: 12px; }
            Text { text: "Shift+drag: Box select"; color: #ccc; font-size: 12px; }
        }
    }

    // Zoom indicator
    Rectangle {
        x: parent.width - 110px;
        y: 10px;
        width: 100px;
        height: 30px;
        background: #00000080;
        border-radius: 4px;

        Text {
            text: "Zoom: " + round(zoom * 100) + "%";
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}
